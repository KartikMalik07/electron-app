name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

# Add permissions for GITHUB_TOKEN
permissions:
  contents: write
  discussions: write
  packages: write

jobs:
  build:
    name: Build Application
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Node.js dependencies
      run: npm ci

    - name: Install Python dependencies
      run: |
        cd python-backend
        pip install -r requirements.txt

    - name: Build Electron app (Windows)
      run: npm run build-win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: List dist directory contents (Debug)
      run: |
        echo "Contents of dist directory:"
        dir dist /s
      shell: cmd

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          dist/*.exe
          dist/*.msi
          dist/*.blockmap
        retention-days: 30

  create-model-instructions:
    name: Create Model Download Instructions
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create model download instructions for v1.0.0
      run: |
        mkdir -p model-instructions

        cat > model-instructions/DOWNLOAD_MODELS_v1.txt << EOF
        ðŸ˜ Airavat v1.0.0 - Model Setup

        ðŸ“¥ AI Models Required (Separate Download)

        Due to GitHub file size limitations, model files are not included in v1.0.0.

        ðŸ”— Download Options:
        1. **Wait for v2.0.0**: Models will be included in the next release
        2. **Manual Setup**: Train your own models using the provided scripts
        3. **Contact Developer**: Request access to pre-trained models

        ðŸ“ Required Files:
        - python-backend/models/siamese_best_model.pth (~100MB)
        - python-backend/models/yolo_best_model.pt (~12MB)

        ðŸ—ï¸ Training Your Own Models:
        - Follow the training scripts in the repository
        - Requires elephant dataset (not included)
        - Estimated training time: 4-8 hours on modern GPU

        âš¡ Quick Start Without Models:
        - The application will run but AI features will be limited
        - UI and system checks will work normally
        - Model status will show "Not Available"

        ðŸ”„ Upgrade to v2.0.0:
        - v2.0.0 will include pre-trained models
        - Full AI functionality out-of-the-box
        - No additional downloads required

        For questions: https://github.com/yourusername/electron-app/issues
        EOF

        cat > model-instructions/README_v1.md << EOF
        # Airavat v1.0.0

        ## ðŸš€ Quick Start (Windows)

        1. **Download**: \`Airavat-Setup-1.0.0.exe\`
        2. **Install**: Run the installer
        3. **Launch**: Application will start automatically
        4. **Note**: AI models not included (see MODEL SETUP below)

        ## ðŸ¤– Model Setup Required

        This version (v1.0.0) includes the complete application but **AI models are sold separately** due to file size constraints.

        ### Option 1: Wait for v2.0.0 (Recommended)
        - Complete package with pre-trained models
        - No additional setup required
        - Full AI functionality included

        ### Option 2: Manual Model Setup
        1. Obtain model files (contact developer or train yourself)
        2. Place in: \`python-backend/models/\`
        3. Restart application

        ## ðŸ“‹ What's Included in v1.0.0

        âœ… **Working Features:**
        - Complete desktop application
        - User interface for all AI features
        - Python backend server
        - System requirement checks
        - File handling and preprocessing

        â³ **Requires Models:**
        - Siamese Network identification
        - YOLOv8 elephant detection
        - Batch processing with AI

        ## ðŸ”§ System Requirements

        - **OS**: Windows 10/11 (64-bit)
        - **RAM**: 8GB minimum, 16GB recommended
        - **Storage**: 10GB available space
        - **Python**: 3.8-3.11 (included in installer)
        - **Optional**: NVIDIA GPU for faster processing

        ## ðŸ†˜ Support

        - **Issues**: https://github.com/yourusername/electron-app/issues
        - **Documentation**: See repository README
        - **Models**: Contact developer for access

        ---
        **Next Release**: v2.0.0 will include complete AI models!
        EOF

    - name: Upload model instructions
      uses: actions/upload-artifact@v4
      with:
        name: model-instructions
        path: model-instructions/
        retention-days: 30

  release:
    name: Create Release
    needs: [build, create-model-instructions]
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: ./artifacts

    - name: List downloaded artifacts (Debug)
      run: |
        echo "Downloaded artifacts:"
        find ./artifacts -type f -ls

    - name: Get version from tag or input
      id: get_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release Notes for v1.0.0
      run: |
        cat > release_notes.md << EOF
        # ðŸ˜ Airavat v1.0.0 (Windows Release)

        ## ðŸŽ‰ First Official Release!

        This is the initial release of Airavat, featuring a complete Windows desktop application for AI-powered elephant identification.

        ## âš ï¸ Important: Models Sold Separately

        **This version includes the complete application framework but AI models are not included due to GitHub file size limitations.**

        ### ðŸ“¥ What's Included
        - âœ… **Complete Windows Application** (\`Airavat-Setup-1.0.0.exe\`)
        - âœ… **Python Backend Server** with all AI processing logic
        - âœ… **Modern Electron Frontend** with intuitive user interface
        - âœ… **System Requirements Checker** and setup validation
        - âœ… **Complete Documentation** and installation guides

        ### ðŸ¤– AI Models (Separate Download Required)
        - âŒ **Siamese Network Model** (siamese_best_model.pth) - ~100MB
        - âŒ **YOLOv8 Detection Model** (yolo_best_model.pt) - ~12MB

        ## ðŸš€ Quick Start

        1. **Download**: \`Airavat-Setup-1.0.0.exe\` (Windows only)
        2. **Install**: Run the installer with administrator privileges
        3. **Launch**: Application will start automatically
        4. **Check Status**: Go to Home tab to verify system requirements
        5. **Note**: AI features will show "Model Not Available" until models are added

        ## ðŸ”§ System Requirements

        ### Minimum Requirements
        - **OS**: Windows 10 (64-bit) or Windows 11
        - **RAM**: 8GB
        - **Storage**: 10GB free space
        - **CPU**: Dual-core processor

        ### Recommended
        - **OS**: Windows 11
        - **RAM**: 16GB or more
        - **Storage**: 50GB+ free space
        - **CPU**: Quad-core processor
        - **GPU**: NVIDIA GPU with CUDA support (optional)

        ## ðŸ› ï¸ For Developers

        ### AI Model Requirements
        If you have access to the model files:
        1. Place \`siamese_best_model.pth\` in \`python-backend/models/\`
        2. Place \`yolo_best_model.pt\` in \`python-backend/models/\`
        3. Restart the application

        ### Training Your Own Models
        - Siamese Network: Individual elephant identification
        - YOLOv8: Elephant detection and localization
        - Dataset: 266 individual Asian elephants (not included)
        - Training scripts available in repository

        ## ðŸ“‹ Known Limitations (v1.0.0)

        - Windows-only release
        - AI models require separate download/training
        - Limited to CPU processing without CUDA setup
        - Batch processing requires manual folder selection

        ## ðŸ› Reporting Issues

        Found a bug or need help?
        - **GitHub Issues**: https://github.com/yourusername/electron-app/issues
        - **Documentation**: Check the repository README
        - **Model Access**: Contact repository maintainer

        ## ðŸŽ¯ What's Next?

        **Future Release Plans:**
        - Include complete AI model package
        - Enhanced batch processing
        - Performance optimizations
        - Advanced elephant identification features

        ---

        **Download**: Get started with \`Airavat-Setup-1.0.0.exe\` below!

        **Full Changelog**: https://github.com/yourusername/electron-app/commits/v1.0.0
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: "Airavat ${{ steps.get_version.outputs.VERSION }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          artifacts/**/*
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
